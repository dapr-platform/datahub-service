# 开发思路

## 数据底座架构设计

数据底座架构设计以数据为核心，通过构建层次化、模块化和安全高效的数据管理与服务体系，将数据资源转化为数据资产，进而支撑智慧园区的运营和发展。园区数据底座架构分为以下三个层次：

### 一、原始数据汇聚层

负责园区内各类原始数据的采集、加工及入库过程，构成数据底座的基础。包含核心功能模块：

- **数据采集与预处理模块**：实现园区内各种数据源的广泛接入和实时采集
- **数据处理模块**：实现数据的进一步加工处理和分析任务
- **数据存储模块**：为初步处理及精细化加工后的数据提供稳定、高效的存储

### 二、数据资产加工层

负责将原始数据转化为高价值的数据资产，并对数据资产进行控制和管理。包含核心能力：

- **数据资产中心**：由一系列主题库组成，作为智慧园区核心数据资产的表达
- **数据治理模块**：确保数据资产的质量、安全性和合规性
- **数据运维模块**：确保数据底座架构稳定运行的关键支撑

### 三、数据开放共享层

负责数据的开放与共享，对外提供服务，推动数据价值的最大化输出。通过 API 管理、数据订阅分发、数据格式转化和数据安全传输等机制，实现数据的开放共享。

## 数据分为实时和批量

### 实时数据处理

- 支持秒级和分钟级粒度对在线数据的实时和准实时处理
- 处理高吞吐量的实时数据流，确保数据量激增时保持稳定性能
- 支持多源数据的实时融合处理
- 提供灵活的调度机制和详细的任务日志、监控功能

### 批量数据处理

- 处理非实时、大规模批量数据的能力
- 支持多源数据的融合处理
- 提供灵活的调度机制，允许用户定制离线任务的执行时间和频率
- 提供详细的任务日志和任务监控功能

## 数据基础库管理

数据基础库用于存储未经加工的原始数据，保持数据的原始格式和完整性。

数据基础库模型

1. 中文名称、英文名称：英文名称作为数据库的 schema,要有格式要求
2. 接口（多个接口，可增删改查）
   2.1 接口模型：
   2.1.0 中文名称、英文名称：英文名称对应数据库的表
   2.1.1 类型（实时、批量）
   2.1.2 数据源（实时的包括 kafka/redis/nats/http 等，批量包括 http(s)/db/hostpath 等
   2.1.2.1 不同的数据源有不同的连接配置字段，接口参数变量等
   2.1.3 接口字段配置(即表结构)
   2.1.4 不同的数据源有不同的解析逻辑，例如消息需要解析 json，批量需要解析分页、字段映射等，还需要选择一些数据清洗规则
   2.1.5 批量的数据源需要配置定时调用方式

### 数据源管理

- 数据源注册：允许用户将不同的数据源注册到数据底座中
- 数据源连接配置：配置数据源的连接参数，确保正确连接
- 数据源监控：实时监控数据源的运行状况

### 数据抽取方式

- 直接数据库连接：通过 SQL 查询或存储过程抽取数据
- API 调用：从内部或外部系统获取数据
- 文件采集：支持从各种格式的文件导入数据
- 消息队列：通过消息队列订阅和消费数据
- 数据推送：通过数据推送机制实现数据交互
- 手动数据输入：允许用户手动输入数据
- 数据同步工具：同步不同系统之间的数据

### 数据清洗

- 处理缺失数据
- 添加默认值
- 删除不完整的行/列
- 规范化数据类型
- 对人工录入数据进行变换
- 重命名列名
- 删除空行/非法数据/重复数据

### 数据标准化

- 值映射：对源表和目标表的字段进行映射
- 统计：对字段求和、求平均、求最大或最小值
- 计算：将字段进行加、减、乘、除
- 拆分字段：将原有字段拆分成新的字段
- 合并：将来自不同步骤的数据流合并
- 分组、行转列、排序、过滤、增加常量等操作

## 数据主题库管理

主题库是按照特定主题或业务领域组织的数据集合，支持复杂的查询和分析。

数据主题库模型

1. 中文名称、英文名称：英文名称作为数据库的 schema,要有格式要求
2. 开放接口
   2.1 接口模型
   2.1.1 中文名称、英文名称：英文名称对应数据库的表
   2.1.2 类型（实时或 http)
   2.1.2.1 不同类型要定义不同的配置
   2.1.3 字段定义

2.2 数据抽取处理
2.2.1 使用有向无环图的任务流程图的方式
2.2.2 卡片包括（数据源、值映射、统计、拆分、合并、分组、行转列、排序、过滤、增加常量等）

### 数据模型管理

- 数据结构查阅/导入/更新
- 数据关系查阅/创建/更新
- 数据约束查阅/创建/更新

### 数据质量管理

- 数据采集连续性检查
- 数据采集完整性检查
- 数据采集准确性检查
- 数据自动补采
- 数据质量告警

## 数据治理

### 数据质量管理

- 数据完整性管理：检查数据集中是否存在缺失值或空字段
- 数据规范性管理：验证数据是否符合预定义的格式、类型和约束条件
- 数据一致性管理：检查跨系统数据之间是否存在逻辑冲突
- 数据准确性管理：通过比对源数据与目标数据，识别错误
- 数据唯一性管理：检测数据中的重复记录
- 数据时效性管理：跟踪数据的时间戳或更新频率
- 数据质量报告生成

### 元数据管理

- 元数据查询：按元数据名称、类别的查询
- 数据资产地图：实现不同来源的元数据有效集成
- 技术元数据管理：描述数据结构、映射、转换等
- 业务元数据管理：描述业务术语、信息分类、指标等
- 管理元数据管理：描述人员角色、岗位职责等

### 数据监控

- 数据访问频次监控
- 数据访问来源监控
- 数据存储空间监控

### 数据脱敏

- 敏感信息识别
- 脱敏策略制定
- 脱敏规则应用
- 脱敏效果验证

### 数据审计

- 审计日志收集
- 合规性检查与报告

## 数据运维

### 用户管理

- 用户账户的创建、修改、禁用和删除
- 用户登录身份认证
- 支持与园区统一账号系统进行单点登录集成

### 权限管理

- 基于角色的访问控制（RBAC）
- 精确限定每个用户的权限范围

### 日志管理

- 详细的日志记录
- 追踪每个操作的时间、执行者、影响范围

### 备份管理

- 对关键主题库、关键数据项进行备份
- 设置定时备份策略实现自动备份

### 自监控管理

- 服务器状态、核心应用状态监控
- 存储组件状态、数据缓存组件状态监控
- 告警通知机制

## 数据共享服务

### 数据目录管理

- 数据基础库目录
- 数据主题库目录
- 数据使用申请
- 数据使用授权

### 数据开放方式

- 数据 API：通过 API 访问数据
- 数据订阅：订阅特定的数据更新
- 库表同步：实现与外部数据库的表级同步

### 数据安全与鉴权

- 数据安全传输：确保传输过程中的安全性
- 数据鉴权认证：验证用户身份，授权访问资源

## 访问控制管理

访问控制管理是数据治理中的核心环节，负责确保只有经过授权的用户或系统可以访问特定数据资源。

1. 生成 token

   - 支持多种认证方式（如密码、证书）
   - 设置 token 有效期
   - 支持 token 刷新与废止

2. 配置 token 可访问的主题库和接口

   - 用户身份认证：验证试图访问数据的用户或系统身份
   - 用户权限分配：根据用户角色分配相应的数据访问权限
   - 应用访问控制列表（ACL）：明确指定哪些系统可以访问哪些数据资源
   - 支持按主题库粒度授权
   - 支持按接口粒度授权
   - 支持按操作类型（读/写）授权

3. API 访问控制
   - API 调用频率限制
   - API 调用日志记录
   - 异常访问监控与告警

# 数据底座服务开发要点

## 项目架构

### 分层架构设计

```
┌─────────────────────────────────────────┐
│                API层                    │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   路由配置   │  │   控制器层      │   │
│  │  routes.go  │  │  controllers/   │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────┐
│               服务层                     │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │  业务服务    │  │   数据模型      │   │
│  │ *_service.go│  │   models/       │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────┐
│              数据访问层                  │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │  数据库操作  │  │   数据迁移      │   │
│  │ database/   │  │   migrate.go    │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
```

### 核心组件

1. **API 层 (api/)**

   - `routes.go`: 路由配置和中间件
   - `controllers/`: HTTP 请求处理器

2. **服务层 (service/)**

   - `models/`: 数据模型定义
   - `*_service.go`: 业务逻辑服务
   - `database/`: 数据库操作和迁移

3. **基础设施**
   - `main.go`: 应用入口点
   - `docs/`: Swagger 文档
   - `dev_docs/`: 开发文档

## 开发规范

### 1. 代码注释标准

每个 Go 文件必须包含标准化的文件头注释：

```go
/*
 * @module 模块名称
 * @description 模块功能描述
 * @architecture 架构模式
 * @documentReference 相关文档路径
 * @stateFlow 状态流转描述
 * @rules 业务规则和约束
 * @dependencies 依赖的模块或包
 * @refs 相关参考文档
 */
```

### 2. 数据模型设计原则

- **UUID 主键**: 所有实体使用 UUID 作为主键
- **软删除**: 通过 status 字段实现软删除
- **时间戳**: 统一使用 created_at 和 updated_at 字段
- **JSONB 存储**: 复杂配置使用 PostgreSQL 的 JSONB 类型
- **关联关系**: 使用 GORM 的关联功能定义实体关系

### 3. API 设计规范

- **RESTful 风格**: 遵循 REST API 设计原则
- **统一响应格式**: 使用 APIResponse 和 PaginatedResponse 结构
- **错误处理**: 统一的错误响应格式
- **Swagger 注释**: 完整的 API 文档注释

### 4. 服务层设计

- **单一职责**: 每个服务类负责单一业务领域
- **依赖注入**: 通过构造函数注入依赖
- **事务支持**: 复杂操作使用数据库事务
- **错误处理**: 明确的错误信息和类型

## 数据库设计

### 核心实体关系

```
BasicLibrary (数据基础库)
    ├── DataInterface (数据接口)
    │   ├── DataSource (数据源)
    │   ├── InterfaceField (接口字段)
    │   └── CleansingRule (清洗规则)

ThematicLibrary (数据主题库)
    ├── ThematicInterface (主题接口)
    │   └── DataFlowGraph (数据流程图)
    │       └── FlowNode (流程节点)

User (用户)
    ├── Role (角色) [多对多]
    │   └── Permission (权限) [多对多]
    └── AccessToken (访问令牌)
        └── TokenPermission (令牌权限)
```

### 数据库迁移

- 使用 GORM 的 AutoMigrate 功能
- 在 service/init.go 中自动执行迁移
- 支持基础数据初始化

## 开发流程

### 1. 添加新功能模块

1. 在`service/models/`中定义数据模型
2. 在`service/database/migrate.go`中添加迁移
3. 创建对应的服务类`service/*_service.go`
4. 创建控制器`api/controllers/*_controller.go`
5. 在`api/routes.go`中添加路由
6. 添加 Swagger 文档注释

### 2. 测试流程

```bash
# 编译检查
go build .

# 运行测试
go test ./...

# 启动服务
go run main.go

# 访问API文档
curl http://localhost/swagger/index.html
```

### 3. 部署流程

```bash
# Docker构建
docker build -t datahub-service .

# Docker Compose启动
docker-compose up -d

# 检查服务状态
curl http://localhost/api/v1/health
```

## 配置管理

### 环境变量

- `DATABASE_URL`: 数据库连接字符串
- `LISTEN_PORT`: 服务监听端口（默认 80）

### 默认配置

```go
// 数据库连接
dsn := "host=localhost user=postgres password=postgres dbname=datahub port=5432 sslmode=disable TimeZone=Asia/Shanghai"

// 服务端口
PORT := 80
```

## 监控和日志

### Prometheus 指标

- 访问`/metrics`端点获取监控数据
- 包含 HTTP 请求指标、数据库连接指标等

### 日志记录

- 使用 Go 标准库 log 包
- 记录数据库连接、迁移、错误等关键信息
- 支持结构化日志输出

## 安全考虑

### 数据访问控制

- 基于 RBAC 的权限管理
- API 访问令牌机制
- 细粒度权限控制

### 数据安全

- 密码哈希存储
- 敏感数据脱敏
- 安全的数据传输

## 性能优化

### 数据库优化

- 合理的索引设计
- 分页查询支持
- 连接池配置

### API 性能

- 响应时间要求：99%的 API 调用在 200ms 内
- 支持并发用户：至少 200 个并发用户
- 缓存策略：Redis 缓存支持

## 扩展性设计

### 微服务架构

- 基于 Dapr 框架
- 支持云原生部署
- 服务间通信标准化

### 水平扩展

- 无状态服务设计
- 数据库读写分离支持
- 负载均衡配置

## 故障处理

### 错误恢复

- 数据库连接重试机制
- 优雅的服务关闭
- 健康检查端点

### 监控告警

- 服务状态监控
- 数据库性能监控
- 错误率告警

## 开发工具

### 推荐 IDE 配置

- VS Code + Go 扩展
- GoLand
- 代码格式化：gofmt
- 代码检查：golint, go vet

### 调试工具

- Delve 调试器
- Postman API 测试
- pgAdmin 数据库管理

## 部署环境

### 开发环境

- 本地 PostgreSQL 数据库
- 直接运行 Go 程序
- 热重载支持

### 生产环境

- Docker 容器化部署
- Kubernetes 集群
- 数据库高可用配置
- 监控和日志收集
